<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ColeGPT</title>
  <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />

    <!-- Latest compiled JavaScript for bootstrap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

    <!-- fontawesome -->
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
    />
    <link rel="stylesheet" href="styles/style.css" />

    <script src="scripts/chatgpt.js"></script>

    <script type="text/javascript" >
      var chatContent;
      async function onload() {
        var apiResp = await fetch('https://dev.skctechnologies.com/OAI.html');
        apiKey = await apiResp.text();

        chatContent = document.getElementById("insertbefore");

        var welcomeMsg = document.createElement("div");
        welcomeMsg.classList = "media media-list";
        welcomeMsg.innerHTML = `<img class='avatar' src='https://img.icons8.com/color/36/000000/administrator-male.png' alt='...' />
                  <div class='media-body'>
                  <p>Hello there! I am ColeGPT, ask me anything!</p></div>`;
                  chatContent.before(welcomeMsg);

        // add enter handler on chat box
        // Get the input field
        var input = document.getElementById("userInput");
        // Execute a function when the user presses a key on the keyboard
        input.addEventListener("keypress", function(event) {
          // If the user presses the "Enter" key on the keyboard
          if (event.key === "Enter") {
            // Cancel the default action, if needed
            event.preventDefault();
            // Trigger the button element with a click
            btnSend_Click();
          }
        });
        input.focus();

        //addThinking();
      }
      function btnSend_Click() {
        var userInput = document.getElementById("userInput");
        var userInputVal = userInput.value;
        userInput.value = "";
        setUserInput(userInputVal);     
        
        addThinking();
        // send user input to backend and get response
        chatGptCompletion(userInputVal)
          .then(data => {
              var results = data.choices[0].message.content;
              var resultsMessage = document.createElement("div");
              resultsMessage.classList = "media media-chat";
              resultsMessage.innerHTML = "<div class='media-body'>\
              <p>" + results + "</p>\
              </div>"
              chatContent.before(resultsMessage);
              chatContent.scrollIntoView({ behavior: "smooth"});
              removeThinking();
        });
      }
      function addThinking() {
        var thinkingMessage = document.createElement("div");
        thinkingMessage.id="thinkingMessage";
        thinkingMessage.classList = "media media-chat";
        thinkingMessage.innerHTML = "<div class='media-body'>\
            <div class='spinner-grow' style='background-color:blue;' role='status'>\
              <span class='visually-hidden'></span>\
            </div>\
          </div>";
        chatContent.before(thinkingMessage);
        chatContent.scrollIntoView({ behavior: "smooth"});
      }

      function removeThinking() {
        var element = document.getElementById("thinkingMessage");
        if(element) {
          element.remove();
        }
      }
      function setUserInput(userInputVal) {
        if(userInputVal && userInputVal.length > 0) {
          var userInputMessage = document.createElement("div");
          userInputMessage.classList = "media media-chat media-chat-reverse";
          userInputMessage.innerHTML = "<div class='media-body'>\
          <p>" + userInputVal + "</p>\
          <p class='meta'><time datetime='2018'>" +
          new Date().toLocaleTimeString() +
          "</time></p>\
                  </div>";
          chatContent.before(userInputMessage);
          chatContent.scrollIntoView({ behavior: "smooth"});
        }
      }
    </script>
</head>
<body onload="onload()">
    <div class="page-content page-container" id="page-content">
      <div class="padding">
        <div class="row d-flex justify-content-center">
          <div class="col-12">
            <div class="card card-bordered">
              <div class="card-header">
                <h4 class="card-title"><strong>ColeGPT</strong></h4>
                <span class="circle" onclick="location.reload();"></span>
              </div>
              <div
                class="ps-container ps-theme-default ps-active-y"
                id="chat-content"
                style="overflow-y: scroll !important; height: 70vh !important"
              >
                <div id="insertbefore"></div>
                <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px">
                  <div
                    class="ps-scrollbar-x"
                    tabindex="0"
                    style="left: 0px; width: 0px"
                  ></div>
                </div>
                <div
                  class="ps-scrollbar-y-rail"
                  style="top: 0px; height: 0px; right: 2px"
                >
                  <div
                    class="ps-scrollbar-y"
                    tabindex="0"
                    style="top: 0px; height: 2px"
                  ></div>
                </div>
              </div>
              <div class="publisher bt-1 border-light">
                <img draggable="true" id="drag-test"
                  class="avatar avatar-xs"
                  src="https://img.icons8.com/color/36/000000/administrator-male.png"
                  alt="..."
                />
                <textarea
                  class="publisher-input"
                  type="text"
                  id="userInput"
                  placeholder="Tell me what you'd like to do!"
                ></textarea>
                <div class="publisher-btn text-info" data-abc="true" onclick="btnSend_Click()"
                  ><i class="fa fa-paper-plane"></i
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</body>
</html>